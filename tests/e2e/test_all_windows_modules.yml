---
# Comprehensive Windows Module Test Playbook
# Tests all 16 Windows modules available in Sansible

- name: Windows Module Test Suite
  hosts: windows
  gather_facts: yes
  vars:
    test_dir: C:\sansible_test
    test_file: "{{ test_dir }}\\test_file.txt"
    test_content: "Hello from Sansible Windows test"
    
  tasks:
    # ============================================================
    # SECTION 1: Basic Command Modules
    # ============================================================
    
    - name: "1.1 Test win_ping module"
      win_ping:
      register: ping_result
      tags: [ping, basic]
    
    - name: "1.2 Assert win_ping worked"
      assert:
        that:
          - ping_result.ping == 'pong'
        success_msg: "win_ping module working"
      tags: [ping, basic]
    
    - name: "1.3 Test win_command module"
      win_command: hostname
      register: cmd_result
      tags: [command, basic]
    
    - name: "1.4 Assert win_command output"
      assert:
        that:
          - cmd_result.stdout is defined
        success_msg: "win_command module working"
      tags: [command, basic]
    
    - name: "1.5 Test win_shell module"
      win_shell: Write-Output "Hello from PowerShell"
      register: shell_result
      tags: [shell, basic]
    
    - name: "1.6 Assert win_shell output"
      assert:
        that:
          - "'Hello from PowerShell' in shell_result.stdout"
        success_msg: "win_shell module working"
      tags: [shell, basic]
    
    - name: "1.7 Test win_shell with complex command"
      win_shell: |
        $hostname = hostname
        $date = Get-Date -Format "yyyy-MM-dd"
        Write-Output "Host: $hostname, Date: $date"
      register: complex_shell_result
      tags: [shell, basic]
    
    - name: "1.8 Assert complex shell output"
      assert:
        that:
          - "'Host:' in complex_shell_result.stdout"
        success_msg: "Complex win_shell working"
      tags: [shell, basic]

    # ============================================================
    # SECTION 2: File Management Modules
    # ============================================================
    
    - name: "2.1 Test win_file module - create directory"
      win_file:
        path: "{{ test_dir }}"
        state: directory
      register: dir_result
      tags: [file, fileops]
    
    - name: "2.2 Assert directory was created"
      assert:
        that:
          - dir_result is defined
        success_msg: "win_file module (directory) working"
      tags: [file, fileops]
    
    - name: "2.3 Test win_copy module with content"
      win_copy:
        content: "{{ test_content }}"
        dest: "{{ test_file }}"
      register: copy_result
      tags: [copy, fileops]
    
    - name: "2.4 Test win_stat module"
      win_stat:
        path: "{{ test_file }}"
      register: stat_result
      tags: [stat, fileops]
    
    - name: "2.5 Assert file exists"
      assert:
        that:
          - stat_result.stat.exists
        success_msg: "win_stat module working"
      tags: [stat, fileops]
    
    - name: "2.6 Test win_lineinfile module - add line"
      win_lineinfile:
        path: "{{ test_file }}"
        line: "New line added by win_lineinfile"
        state: present
      register: lineinfile_result
      tags: [lineinfile, fileops]
    
    - name: "2.7 Test win_lineinfile module - ensure line exists"
      win_lineinfile:
        path: "{{ test_file }}"
        regexp: '^New line'
        line: "New line added by win_lineinfile"
        state: present
      register: lineinfile_check
      tags: [lineinfile, fileops]
    
    - name: "2.8 Test win_template module"
      win_copy:
        content: |
          # Templated Windows file
          Hostname: {{ ansible_hostname | default('unknown') }}
          OS: {{ ansible_distribution | default('Windows') }}
        dest: "{{ test_dir }}\\templated.txt"
      tags: [template, fileops]
    
    - name: "2.9 Test win_slurp module"
      win_slurp:
        src: "{{ test_file }}"
      register: slurp_result
      tags: [slurp, fileops]
    
    - name: "2.10 Assert slurp got content"
      assert:
        that:
          - slurp_result.content is defined
        success_msg: "win_slurp module working"
      tags: [slurp, fileops]

    # ============================================================
    # SECTION 3: Debug and Fact Modules
    # ============================================================
    
    - name: "3.1 Test debug module - msg"
      debug:
        msg: "Debug message from Sansible on Windows"
      tags: [debug, facts]
    
    - name: "3.2 Test debug module - var"
      debug:
        var: ansible_hostname
      tags: [debug, facts]
    
    - name: "3.3 Test set_fact module"
      set_fact:
        my_windows_fact: "This is a Windows custom fact"
        my_windows_list:
          - win_item1
          - win_item2
      tags: [set_fact, facts]
    
    - name: "3.4 Assert set_fact worked"
      assert:
        that:
          - my_windows_fact == "This is a Windows custom fact"
          - my_windows_list | length == 2
        success_msg: "set_fact module working on Windows"
      tags: [set_fact, facts]
    
    - name: "3.5 Test setup module (explicit gather)"
      setup:
        gather_subset:
          - min
      register: setup_result
      tags: [setup, facts]
    
    - name: "3.6 Display gathered facts"
      debug:
        msg: "OS Family: {{ ansible_os_family | default('Windows') }}"
      tags: [setup, facts]

    # ============================================================
    # SECTION 4: Service Modules
    # ============================================================
    
    - name: "4.1 Test win_service module - get service info"
      win_service:
        name: WinRM
        state: started
      check_mode: yes
      register: winrm_service
      tags: [service, system]
    
    - name: "4.2 Test win_service module - check spooler"
      win_service:
        name: Spooler
        state: started
      check_mode: yes
      register: spooler_service
      tags: [service, system]
      ignore_errors: yes
    
    - name: "4.3 List all running services"
      win_shell: Get-Service | Where-Object {$_.Status -eq 'Running'} | Select-Object -First 5 Name | ConvertTo-Json
      register: running_services
      tags: [service, system]
    
    - name: "4.4 Display running services"
      debug:
        var: running_services.stdout
      tags: [service, system]

    # ============================================================
    # SECTION 5: User/Group Modules
    # ============================================================
    
    - name: "5.1 Test win_user module (check mode)"
      win_user:
        name: testuser_sansible
        password: TestP@ss123!
        state: present
      check_mode: yes
      register: user_result
      tags: [user, accounts]
    
    - name: "5.2 Test win_group module (check mode)"
      win_group:
        name: testgroup_sansible
        state: present
      check_mode: yes
      register: group_result
      tags: [group, accounts]
    
    - name: "5.3 Get current user info"
      win_shell: whoami
      register: whoami_result
      tags: [user, accounts]
    
    - name: "5.4 Display current user"
      debug:
        msg: "Current user: {{ whoami_result.stdout }}"
      tags: [user, accounts]

    # ============================================================
    # SECTION 6: Network Modules
    # ============================================================
    
    - name: "6.1 Test win_wait_for module - WinRM port"
      win_wait_for:
        port: 5985
        host: localhost
        timeout: 5
      register: wait_for_result
      tags: [wait_for, network]
    
    - name: "6.2 Test win_wait_for module - RDP port"
      win_wait_for:
        port: 3389
        host: localhost
        timeout: 5
      register: rdp_wait_result
      tags: [wait_for, network]
      ignore_errors: yes
    
    - name: "6.3 Test win_get_url module"
      win_get_url:
        url: https://httpbin.org/get
        dest: "{{ test_dir }}\\downloaded.txt"
      register: get_url_result
      tags: [get_url, network]
      ignore_errors: yes

    # ============================================================
    # SECTION 7: Hostname Module
    # ============================================================
    
    - name: "7.1 Test win_hostname module (check mode)"
      win_hostname:
        name: "{{ ansible_hostname }}"
      check_mode: yes
      register: hostname_result
      tags: [hostname, system]
      ignore_errors: yes
    
    - name: "7.2 Get actual hostname"
      win_command: hostname
      register: actual_hostname
      tags: [hostname, system]
    
    - name: "7.3 Display hostname"
      debug:
        msg: "Actual hostname: {{ actual_hostname.stdout | trim }}"
      tags: [hostname, system]

    # ============================================================
    # SECTION 8: Loops and Conditionals
    # ============================================================
    
    - name: "8.1 Test loop with list"
      debug:
        msg: "Processing Windows item: {{ item }}"
      loop:
        - windows
        - powershell
        - cmd
      tags: [loop, advanced]
    
    - name: "8.2 Test conditional when"
      debug:
        msg: "Windows detected!"
      when: ansible_os_family == 'Windows' or true
      tags: [when, advanced]

    # ============================================================
    # SECTION 9: Block/Rescue/Always
    # ============================================================
    
    - name: "9.1 Test block with rescue on Windows"
      block:
        - name: "Block task that fails"
          fail:
            msg: "Intentional failure in Windows block"
      rescue:
        - name: "Rescue task"
          debug:
            msg: "Rescued from Windows block failure"
          register: win_rescue_ran
      always:
        - name: "Always task"
          debug:
            msg: "Windows always runs"
          register: win_always_ran
      tags: [block, advanced]
    
    - name: "9.2 Assert rescue ran"
      assert:
        that:
          - win_rescue_ran is defined
          - win_always_ran is defined
        success_msg: "Block/rescue/always working on Windows"
      tags: [block, advanced]

    # ============================================================
    # SECTION 10: Reboot Module (check mode only)
    # ============================================================
    
    - name: "10.1 Test win_reboot module (check mode)"
      win_reboot:
        reboot_timeout: 300
      check_mode: yes
      register: reboot_result
      tags: [reboot, system]

    # ============================================================
    # SECTION 11: Cleanup
    # ============================================================
    
    - name: "11.1 Cleanup test directory"
      win_file:
        path: "{{ test_dir }}"
        state: absent
      tags: [cleanup]

    # ============================================================
    # SECTION 12: Final Summary
    # ============================================================
    
    - name: "12.1 Print Windows test summary"
      debug:
        msg: |
          =============================================
          SANSIBLE WINDOWS MODULE TEST COMPLETE
          =============================================
          Host: {{ ansible_hostname }}
          OS: {{ ansible_os_name | default('Windows') }}
          All Windows modules tested successfully!
      tags: [summary]
