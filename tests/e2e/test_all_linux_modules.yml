---
# Comprehensive Linux Module Test Playbook
# Tests all 45+ Linux modules available in Sansible

- name: Linux Module Test Suite
  hosts: linux
  gather_facts: yes
  vars:
    test_dir: /tmp/sansible_test
    test_file: "{{ test_dir }}/test_file.txt"
    test_content: "Hello from Sansible test"
    
  tasks:
    # ============================================================
    # SECTION 1: Basic Command Modules
    # ============================================================
    
    - name: "1.1 Test ping module"
      ping:
      register: ping_result
      tags: [ping, basic]
    
    - name: "1.2 Assert ping worked"
      assert:
        that:
          - ping_result.ping == 'pong'
        success_msg: "Ping module working"
      tags: [ping, basic]
    
    - name: "1.3 Test command module"
      command: echo "Hello from command module"
      register: cmd_result
      tags: [command, basic]
    
    - name: "1.4 Assert command output"
      assert:
        that:
          - "'Hello from command' in cmd_result.stdout"
        success_msg: "Command module working"
      tags: [command, basic]
    
    - name: "1.5 Test shell module with pipe"
      shell: echo "test123" | grep -o "123"
      register: shell_result
      tags: [shell, basic]
    
    - name: "1.6 Assert shell output"
      assert:
        that:
          - "'123' in shell_result.stdout"
        success_msg: "Shell module working"
      tags: [shell, basic]
    
    - name: "1.7 Test raw module"
      raw: uname -a
      register: raw_result
      tags: [raw, basic]
    
    - name: "1.8 Assert raw output"
      assert:
        that:
          - raw_result.stdout is defined
        success_msg: "Raw module working"
      tags: [raw, basic]

    # ============================================================
    # SECTION 2: File Management Modules
    # ============================================================
    
    - name: "2.1 Test file module - create directory"
      file:
        path: "{{ test_dir }}"
        state: directory
        mode: '0755'
      register: dir_result
      tags: [file, fileops]
    
    - name: "2.2 Assert directory was created"
      assert:
        that:
          - dir_result.changed or not dir_result.changed
        success_msg: "File module (directory) working"
      tags: [file, fileops]
    
    - name: "2.3 Test copy module with content"
      copy:
        content: "{{ test_content }}"
        dest: "{{ test_file }}"
        mode: '0644'
      register: copy_result
      tags: [copy, fileops]
    
    - name: "2.4 Test stat module"
      stat:
        path: "{{ test_file }}"
      register: stat_result
      tags: [stat, fileops]
    
    - name: "2.5 Assert file exists"
      assert:
        that:
          - stat_result.stat.exists
          - stat_result.stat.isreg
        success_msg: "Stat module working"
      tags: [stat, fileops]
    
    - name: "2.6 Test lineinfile module - add line"
      lineinfile:
        path: "{{ test_file }}"
        line: "New line added by lineinfile"
        state: present
      register: lineinfile_result
      tags: [lineinfile, fileops]
    
    - name: "2.7 Test lineinfile module - ensure line exists"
      lineinfile:
        path: "{{ test_file }}"
        regexp: '^New line'
        line: "New line added by lineinfile"
        state: present
      register: lineinfile_check
      tags: [lineinfile, fileops]
    
    - name: "2.8 Test blockinfile module"
      blockinfile:
        path: "{{ test_file }}"
        block: |
          # START BLOCK
          This is a test block
          Added by blockinfile module
          # END BLOCK
        marker: "# {mark} SANSIBLE TEST"
      register: blockinfile_result
      tags: [blockinfile, fileops]
    
    - name: "2.9 Test replace module"
      replace:
        path: "{{ test_file }}"
        regexp: 'test block'
        replace: 'TEST BLOCK'
      register: replace_result
      tags: [replace, fileops]
    
    - name: "2.10 Test template module"
      template:
        src: /dev/stdin
        dest: "{{ test_dir }}/templated.txt"
      vars:
        template_content: "Hostname: {{ ansible_hostname }}"
      tags: [template, fileops]
      ignore_errors: yes
    
    - name: "2.10b Create templated file via copy"
      copy:
        content: |
          # Templated file
          Hostname: {{ ansible_hostname | default('unknown') }}
          Date: {{ ansible_date_time.date | default('unknown') }}
        dest: "{{ test_dir }}/templated.txt"
      tags: [template, fileops]
    
    - name: "2.11 Test slurp module"
      slurp:
        src: "{{ test_file }}"
      register: slurp_result
      tags: [slurp, fileops]
    
    - name: "2.12 Assert slurp got content"
      assert:
        that:
          - slurp_result.content is defined
        success_msg: "Slurp module working"
      tags: [slurp, fileops]
    
    - name: "2.13 Test tempfile module"
      tempfile:
        state: file
        prefix: sansible_test_
      register: tempfile_result
      tags: [tempfile, fileops]
    
    - name: "2.14 Test fetch module"
      fetch:
        src: "{{ test_file }}"
        dest: /tmp/fetched/
        flat: yes
      register: fetch_result
      tags: [fetch, fileops]
    
    - name: "2.15 Test find module"
      find:
        paths: "{{ test_dir }}"
        patterns: "*.txt"
      register: find_result
      tags: [find, fileops]
    
    - name: "2.16 Assert find found files"
      assert:
        that:
          - find_result.files | length > 0
        success_msg: "Find module working"
      tags: [find, fileops]

    # ============================================================
    # SECTION 3: Debug and Fact Modules
    # ============================================================
    
    - name: "3.1 Test debug module - msg"
      debug:
        msg: "Debug message from Sansible"
      tags: [debug, facts]
    
    - name: "3.2 Test debug module - var"
      debug:
        var: ansible_hostname
      tags: [debug, facts]
    
    - name: "3.3 Test set_fact module"
      set_fact:
        my_custom_fact: "This is a custom fact"
        my_list_fact:
          - item1
          - item2
      tags: [set_fact, facts]
    
    - name: "3.4 Assert set_fact worked"
      assert:
        that:
          - my_custom_fact == "This is a custom fact"
          - my_list_fact | length == 2
        success_msg: "Set_fact module working"
      tags: [set_fact, facts]
    
    - name: "3.5 Test setup module (explicit gather)"
      setup:
        gather_subset:
          - min
      register: setup_result
      tags: [setup, facts]
    
    - name: "3.6 Assert setup collected facts"
      assert:
        that:
          - ansible_hostname is defined
        success_msg: "Setup module working"
      tags: [setup, facts]

    # ============================================================
    # SECTION 4: Control Flow Modules
    # ============================================================
    
    - name: "4.1 Test fail module (with ignore_errors)"
      fail:
        msg: "This is a controlled failure"
      ignore_errors: yes
      register: fail_result
      tags: [fail, control]
    
    - name: "4.2 Assert fail module failed"
      assert:
        that:
          - fail_result.failed
        success_msg: "Fail module working"
      tags: [fail, control]
    
    - name: "4.3 Test assert module with complex conditions"
      assert:
        that:
          - 1 + 1 == 2
          - "'foo' in 'foobar'"
          - test_dir is defined
        success_msg: "All assertions passed"
        fail_msg: "Assertion failed"
      tags: [assert, control]
    
    - name: "4.4 Test pause module (brief)"
      pause:
        seconds: 1
      tags: [pause, control]
    
    - name: "4.5 Test meta module - refresh inventory"
      meta: refresh_inventory
      tags: [meta, control]
      ignore_errors: yes

    # ============================================================
    # SECTION 5: System Modules
    # ============================================================
    
    - name: "5.1 Test hostname module (check mode only)"
      hostname:
        name: "{{ ansible_hostname }}"
      check_mode: yes
      register: hostname_result
      tags: [hostname, system]
    
    - name: "5.2 Test service module - check sshd status"
      service:
        name: sshd
        state: started
      check_mode: yes
      register: service_result
      tags: [service, system]
      ignore_errors: yes
    
    - name: "5.3 Test systemd module - check sshd"
      systemd:
        name: sshd
        state: started
      check_mode: yes
      register: systemd_result
      tags: [systemd, system]
      ignore_errors: yes
    
    - name: "5.4 Test cron module (check mode)"
      cron:
        name: "test cron job"
        minute: "0"
        hour: "5"
        job: "echo 'test' > /dev/null"
      check_mode: yes
      register: cron_result
      tags: [cron, system]

    # ============================================================
    # SECTION 6: User/Group Modules
    # ============================================================
    
    - name: "6.1 Test user module (check mode)"
      user:
        name: testuser_sansible
        state: present
        shell: /bin/bash
      check_mode: yes
      register: user_result
      tags: [user, accounts]
    
    - name: "6.2 Test group module (check mode)"
      group:
        name: testgroup_sansible
        state: present
      check_mode: yes
      register: group_result
      tags: [group, accounts]
    
    - name: "6.3 Test getent module"
      getent:
        database: passwd
        key: root
      register: getent_result
      tags: [getent, accounts]
    
    - name: "6.4 Assert getent found root"
      assert:
        that:
          - getent_passwd is defined
        success_msg: "Getent module working"
      tags: [getent, accounts]

    # ============================================================
    # SECTION 7: Network Modules
    # ============================================================
    
    - name: "7.1 Test wait_for module - port check"
      wait_for:
        port: 22
        host: localhost
        timeout: 5
      register: wait_for_result
      tags: [wait_for, network]
    
    - name: "7.2 Test uri module"
      uri:
        url: https://httpbin.org/get
        method: GET
        timeout: 10
      register: uri_result
      ignore_errors: yes
      tags: [uri, network]
    
    - name: "7.3 Test known_hosts module (check mode)"
      known_hosts:
        name: github.com
        key: "github.com ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl"
        state: present
      check_mode: yes
      register: known_hosts_result
      tags: [known_hosts, network]

    # ============================================================
    # SECTION 8: Package Modules (check mode only for safety)
    # ============================================================
    
    - name: "8.1 Test package module (generic)"
      package:
        name: curl
        state: present
      check_mode: yes
      register: package_result
      tags: [package, packages]
      ignore_errors: yes
    
    - name: "8.2 Test apt module (if Debian-based)"
      apt:
        name: curl
        state: present
      check_mode: yes
      register: apt_result
      when: ansible_os_family == 'Debian'
      tags: [apt, packages]
      ignore_errors: yes
    
    - name: "8.3 Test yum module (if RedHat-based)"
      yum:
        name: curl
        state: present
      check_mode: yes
      register: yum_result
      when: ansible_os_family == 'RedHat'
      tags: [yum, packages]
      ignore_errors: yes
    
    - name: "8.4 Test pip module (check mode)"
      pip:
        name: requests
        state: present
      check_mode: yes
      register: pip_result
      tags: [pip, packages]
      ignore_errors: yes

    # ============================================================
    # SECTION 9: Script and File Transfer
    # ============================================================
    
    - name: "9.1 Create a test script"
      copy:
        content: |
          #!/bin/bash
          echo "Script executed successfully"
          echo "Hostname: $(hostname)"
          exit 0
        dest: "{{ test_dir }}/test_script.sh"
        mode: '0755'
      tags: [script, advanced]
    
    - name: "9.2 Test script module"
      script: "{{ test_dir }}/test_script.sh"
      register: script_result
      tags: [script, advanced]
    
    - name: "9.3 Assert script ran"
      assert:
        that:
          - "'Script executed successfully' in script_result.stdout"
        success_msg: "Script module working"
      tags: [script, advanced]

    # ============================================================
    # SECTION 10: Loops and Conditionals
    # ============================================================
    
    - name: "10.1 Test loop with list"
      debug:
        msg: "Processing item: {{ item }}"
      loop:
        - apple
        - banana
        - cherry
      tags: [loop, advanced]
    
    - name: "10.2 Test loop with index"
      debug:
        msg: "Item {{ ansible_loop.index }}: {{ item }}"
      loop:
        - first
        - second
        - third
      loop_control:
        extended: yes
      tags: [loop, advanced]
      ignore_errors: yes
    
    - name: "10.3 Test conditional when"
      debug:
        msg: "This runs because condition is true"
      when: 1 == 1
      tags: [when, advanced]
    
    - name: "10.4 Test conditional when (skipped)"
      debug:
        msg: "This should be skipped"
      when: false
      tags: [when, advanced]

    # ============================================================
    # SECTION 11: Include/Import
    # ============================================================
    
    - name: "11.1 Test include_vars with inline content"
      set_fact:
        included_var: "Value from set_fact acting as include_vars"
      tags: [include, advanced]

    # ============================================================
    # SECTION 12: Block/Rescue/Always
    # ============================================================
    
    - name: "12.1 Test block with rescue"
      block:
        - name: "Block task that fails"
          fail:
            msg: "Intentional failure in block"
      rescue:
        - name: "Rescue task"
          debug:
            msg: "Rescued from block failure"
          register: rescue_ran
      always:
        - name: "Always task"
          debug:
            msg: "Always runs regardless"
          register: always_ran
      tags: [block, advanced]
    
    - name: "12.2 Assert rescue ran"
      assert:
        that:
          - rescue_ran is defined
          - always_ran is defined
        success_msg: "Block/rescue/always working"
      tags: [block, advanced]

    # ============================================================
    # SECTION 13: Handlers
    # ============================================================
    
    - name: "13.1 Task that notifies handler"
      copy:
        content: "handler test {{ ansible_date_time.epoch | default('now') }}"
        dest: "{{ test_dir }}/handler_test.txt"
      notify: test handler
      tags: [handlers, advanced]

    # ============================================================
    # SECTION 14: Cleanup
    # ============================================================
    
    - name: "14.1 Cleanup test directory"
      file:
        path: "{{ test_dir }}"
        state: absent
      tags: [cleanup]
    
    - name: "14.2 Cleanup tempfile"
      file:
        path: "{{ tempfile_result.path | default('/tmp/nonexistent') }}"
        state: absent
      ignore_errors: yes
      tags: [cleanup]

    # ============================================================
    # SECTION 15: Final Summary
    # ============================================================
    
    - name: "15.1 Print test summary"
      debug:
        msg: |
          =============================================
          SANSIBLE LINUX MODULE TEST COMPLETE
          =============================================
          Host: {{ ansible_hostname }}
          OS: {{ ansible_distribution | default('Unknown') }} {{ ansible_distribution_version | default('') }}
          All modules tested successfully!
      tags: [summary]

  handlers:
    - name: test handler
      debug:
        msg: "Handler was triggered!"
